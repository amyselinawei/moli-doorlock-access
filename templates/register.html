<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MOLI 門禁註冊</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
<div class="page-wrap">
  <header class="moli-header">
    <div class="brand">
      <span class="brand-mark"></span>
      <span>MOLI 門禁系統</span>
    </div>
    <div class="lab-tag">Makers' Open Lab for Innovation</div>
  </header>

  <main class="main-center">
    <div class="card">
      <div class="card-title">進出門禁註冊</div>
      <div class="card-subtitle">
        請先填寫學號與姓名，送出後依畫面指示在 15 秒內刷學生證完成綁定。
      </div>

      <form id="registerForm" method="post" action="/register">
        <label for="student_id">學號</label>
        <input type="text" id="student_id" name="student_id" required />

        <label for="name">姓名</label>
        <input type="text" id="name" name="name" required />

        <button type="submit">送出註冊</button>

        <div class="error" id="errorMsg"></div>
        <div class="hint">僅用於實驗室門禁管理，不會對外公開個人資料。</div>
      </form>
    </div>
  </main>

  <footer class="moli-footer">
    © MOLI – Makers' Open Lab for Innovation
  </footer>
</div>

<!-- Loading modal -->
<div id="loadingModal" class="loading-modal">
  <div id="loadingContent" class="loading-card">
    <div class="modal-title">請刷學生證</div>
    <div class="modal-text">請在 15 秒內於讀卡機上刷卡 2 次完成綁定。</div>
    <div class="spinner"></div>
    <div class="scan-status" id="scanStatus">等待第一次刷卡...</div>
  </div>
</div>

<script>
document.getElementById("registerForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const student_id = form.student_id.value.trim();
  const name = form.name.value.trim();
  const errorMsg = document.getElementById("errorMsg");
  errorMsg.textContent = "";

  if (!student_id || !name) {
    errorMsg.textContent = "學號與姓名不可為空。";
    return;
  }

  const data = new URLSearchParams();
  data.append("student_id", student_id);
  data.append("name", name);

  try {
    const resp = await fetch("/register", {
      method: "POST",
      body: data,
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
    });

    if (resp.redirected) {
      showLoadingModal(student_id);
    } else {
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const err = doc.querySelector(".error");
      errorMsg.textContent = err ? err.textContent.trim() : "註冊失敗，請稍後再試。";
    }
  } catch (err) {
    errorMsg.textContent = "網路錯誤，請確認伺服器是否啟動。";
  }
});

function showLoadingModal(student_id) {
  const modal = document.getElementById("loadingModal");
  const scanStatus = document.getElementById("scanStatus");
  modal.style.display = "block";
  scanStatus.textContent = "等待第一次刷卡...";

  let scanCount = 0;

  function fakeScan() {
    scanCount++;
    scanStatus.textContent = `第 ${scanCount} 次刷卡成功，資料確認中…`;

    fetch("/rfid_scan", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        student_id: student_id,
        rfid_uid: `fakeRFID${scanCount}`,
        action: "entry",
      }),
    })
      .then((res) => {
        if (scanCount >= 2) {
          scanStatus.textContent = "刷卡完成，正在前往結果頁…";
          setTimeout(() => {
            window.location.href = `/success?student_id=${encodeURIComponent(
              student_id
            )}`;
          }, 600);
        } else {
          scanStatus.textContent = "請再刷一次以完成綁定。";
          setTimeout(fakeScan, 4000);
        }
      })
      .catch(() => {
        scanStatus.textContent = "刷卡通訊失敗，請通知助教協助。";
      });
  }

  setTimeout(fakeScan, 1200);

  setTimeout(() => {
    if (scanCount < 2) {
      scanStatus.textContent = "刷卡逾時，請關閉視窗後重新註冊。";
    }
  }, 15000);
}
</script>
</body>
</html>
